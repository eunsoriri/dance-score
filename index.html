<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TM + getUserMedia 예제</title>
  <style>
    #preview { position: relative; width: 400px; height: 400px; margin: 20px auto; }
    video, canvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      border-radius: 10px;
    }
    #score { text-align: center; font-size: 1.2em; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>그대로 멈춰라!</h1>
  <div id="preview">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>
  <div id="score">점수: 0</div>

  <!-- 라이브러리 로드 -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8.4/dist/teachablemachine-pose.min.js"></script>

  <script>
    const URL = "https://teachablemachine.withgoogle.com/models/fJgu3SfBOW/";
    let model, video, canvas, ctx, score = 0;

    async function init() {
      // 1) 모델 로드
      model = await tmPose.load(URL + "model.json", URL + "metadata.json");

      // 2) 비디오 스트림 설정
      video = document.getElementById("webcam");
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      await video.play();

      // 3) 캔버스 준비
      canvas = document.getElementById("overlay");
      ctx = canvas.getContext("2d");

      // 4) 루프 시작
      requestAnimationFrame(loop);
    }

    async function loop() {
      // 1) 영상 프레임 그리기
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // 2) 포즈 추정 & 예측
      const { pose, posenetOutput } = await model.estimatePose(video);
      const prediction = await model.predict(posenetOutput);

      // 3) 스켈레톤 오버레이
      tmPose.drawKeypoints(pose.keypoints, 0.6, ctx);
      tmPose.drawSkeleton(pose.keypoints, 0.7, ctx);

      // 4) 간단 점수: 확률 0.6 이상일 때 +1
      const top = prediction.reduce((a, b) => a.probability > b.probability ? a : b);
      if (top.probability > 0.6) {
        score++;
        document.getElementById("score").innerText = `점수: ${score}`;
      }

      requestAnimationFrame(loop);
    }

    init();
  </script>
</body>
</html>
